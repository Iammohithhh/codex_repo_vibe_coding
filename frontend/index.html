<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paper2Product 2.0 — AI Research OS</title>
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface2: #232635;
  --border: #2d3148;
  --text: #e4e6f0;
  --text-dim: #8b8fa3;
  --accent: #6366f1;
  --accent-light: #818cf8;
  --green: #22c55e;
  --red: #ef4444;
  --orange: #f59e0b;
  --blue: #3b82f6;
  --purple: #a855f7;
  --radius: 10px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
a { color: var(--accent-light); text-decoration: none; }
a:hover { text-decoration: underline; }

/* Layout */
.app { display: flex; min-height: 100vh; }
.sidebar { width: 270px; background: var(--surface); border-right: 1px solid var(--border); padding: 20px; flex-shrink: 0; overflow-y: auto; display: flex; flex-direction: column; }
.main { flex: 1; padding: 24px 32px; overflow-y: auto; max-height: 100vh; }

/* Sidebar */
.logo { font-size: 20px; font-weight: 700; color: var(--accent-light); display: flex; align-items: center; gap: 8px; }
.logo-icon { font-size: 22px; }
.logo-sub { font-size: 12px; color: var(--text-dim); margin-bottom: 20px; margin-top: 2px; }
.nav-section { font-size: 10px; text-transform: uppercase; color: var(--text-dim); letter-spacing: 1.2px; margin: 18px 0 6px; font-weight: 600; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 9px 12px; border-radius: 8px; cursor: pointer; font-size: 13.5px; color: var(--text-dim); transition: all 0.15s; }
.nav-item:hover { background: var(--surface2); color: var(--text); }
.nav-item.active { background: var(--accent); color: white; }
.nav-icon { width: 20px; text-align: center; font-size: 14px; }
.project-list { margin-top: 8px; flex: 1; overflow-y: auto; }
.project-item { padding: 7px 12px; font-size: 13px; color: var(--text-dim); border-radius: 6px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 8px; }
.project-item:hover { background: var(--surface2); color: var(--text); }
.project-item.active { color: var(--accent-light); background: rgba(99,102,241,0.1); }
.project-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.sidebar-footer { margin-top: auto; padding-top: 12px; border-top: 1px solid var(--border); font-size: 11px; color: var(--text-dim); }

/* Cards */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.card-title { font-size: 16px; font-weight: 600; }
.card-subtitle { font-size: 13px; color: var(--text-dim); }

/* Buttons */
.btn { display: inline-flex; align-items: center; gap: 6px; padding: 9px 18px; border: none; border-radius: 8px; font-size: 13.5px; font-weight: 500; cursor: pointer; transition: all 0.15s; font-family: inherit; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-primary { background: var(--accent); color: white; }
.btn-primary:hover:not(:disabled) { background: var(--accent-light); }
.btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover:not(:disabled) { background: var(--border); }
.btn-success { background: var(--green); color: white; }
.btn-danger { background: var(--red); color: white; }
.btn-sm { padding: 5px 12px; font-size: 12px; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

/* Forms */
.form-group { margin-bottom: 16px; }
.form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--text-dim); }
.form-input, .form-textarea, .form-select {
  width: 100%; padding: 10px 12px; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text); font-size: 14px; font-family: inherit;
}
.form-textarea { min-height: 80px; resize: vertical; }
.form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99,102,241,0.15); }
.form-hint { font-size: 11px; color: var(--text-dim); margin-top: 4px; }

/* Import bar */
.import-bar { display: flex; gap: 8px; margin-bottom: 20px; }
.import-bar .form-input { flex: 1; }

/* Tabs */
.tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 20px; overflow-x: auto; }
.tab { padding: 10px 18px; font-size: 13.5px; color: var(--text-dim); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s; white-space: nowrap; }
.tab:hover { color: var(--text); }
.tab.active { color: var(--accent-light); border-bottom-color: var(--accent); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Badges */
.badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
.badge-green { background: rgba(34,197,94,0.15); color: var(--green); }
.badge-red { background: rgba(239,68,68,0.15); color: var(--red); }
.badge-orange { background: rgba(245,158,11,0.15); color: var(--orange); }
.badge-blue { background: rgba(59,130,246,0.15); color: var(--blue); }
.badge-purple { background: rgba(168,85,247,0.15); color: var(--purple); }

/* Grid */
.grid { display: grid; gap: 16px; }
.grid-2 { grid-template-columns: 1fr 1fr; }
.grid-3 { grid-template-columns: 1fr 1fr 1fr; }
.grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }

/* Agent messages */
.agent-msg { padding: 10px 14px; margin-bottom: 8px; border-radius: 8px; font-size: 13px; border-left: 3px solid; }
.agent-msg.reader { border-color: var(--blue); background: rgba(59,130,246,0.08); }
.agent-msg.skeptic { border-color: var(--orange); background: rgba(245,158,11,0.08); }
.agent-msg.implementer { border-color: var(--green); background: rgba(34,197,94,0.08); }
.agent-msg.verifier { border-color: var(--purple); background: rgba(168,85,247,0.08); }
.agent-msg.explainer { border-color: var(--accent); background: rgba(99,102,241,0.08); }
.agent-role { font-weight: 600; text-transform: uppercase; font-size: 11px; margin-bottom: 4px; }

/* Code */
pre { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; overflow-x: auto; font-size: 13px; font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace; line-height: 1.6; max-height: 500px; overflow-y: auto; }
code { font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace; font-size: 12.5px; }
.inline-code { background: var(--surface2); padding: 2px 6px; border-radius: 4px; font-size: 12px; }

/* Code viewer layout */
.code-layout { display: flex; gap: 0; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; min-height: 400px; }
.code-sidebar { width: 220px; background: var(--surface); border-right: 1px solid var(--border); overflow-y: auto; flex-shrink: 0; }
.code-main { flex: 1; overflow: auto; background: var(--bg); }
.code-main pre { border: none; border-radius: 0; margin: 0; min-height: 100%; }
.file-item { padding: 7px 14px; font-size: 12.5px; cursor: pointer; color: var(--text-dim); display: flex; align-items: center; gap: 8px; border-bottom: 1px solid rgba(45,49,72,0.5); }
.file-item:hover { background: var(--surface2); color: var(--text); }
.file-item.active { color: var(--accent-light); background: rgba(99,102,241,0.1); font-weight: 500; }
.file-icon { font-size: 11px; }
.code-header { padding: 10px 16px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 13px; }

/* Table */
table { width: 100%; border-collapse: collapse; }
th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; }
th { color: var(--text-dim); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }

/* Loading */
.spinner { width: 20px; height: 20px; border: 2.5px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-overlay { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 60px; color: var(--text-dim); font-size: 14px; }

/* Progress bar */
.progress-bar { height: 8px; background: var(--surface2); border-radius: 4px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }

/* Score */
.score-ring { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 700; }

/* Stat cards */
.stat-card { text-align: center; padding: 20px; }
.stat-value { font-size: 28px; font-weight: 700; }
.stat-label { font-size: 12px; color: var(--text-dim); margin-top: 4px; }

/* Checklist */
.checklist-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; font-size: 13px; }
.checklist-check { width: 20px; height: 20px; border-radius: 5px; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; }
.checklist-check.done { background: var(--green); border-color: var(--green); color: white; }

/* Toast */
.toast { position: fixed; bottom: 24px; right: 24px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px 20px; font-size: 14px; z-index: 1000; box-shadow: 0 8px 24px rgba(0,0,0,0.4); animation: slideIn 0.3s; max-width: 400px; }
.toast.error { border-color: var(--red); }
.toast.success { border-color: var(--green); }
@keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* Empty state */
.empty-state { text-align: center; padding: 60px 20px; color: var(--text-dim); }
.empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.3; }
.empty-state-title { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 8px; }

/* Pipeline progress */
.pipeline-steps { display: flex; gap: 4px; margin: 16px 0; }
.pipeline-step { flex: 1; text-align: center; padding: 8px; border-radius: 6px; font-size: 11px; font-weight: 600; background: var(--surface2); color: var(--text-dim); }
.pipeline-step.active { background: var(--accent); color: white; animation: pulse 1s infinite; }
.pipeline-step.done { background: rgba(34,197,94,0.2); color: var(--green); }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

/* Responsive */
@media (max-width: 900px) {
  .sidebar { display: none; }
  .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
  .main { padding: 16px; }
  .code-layout { flex-direction: column; }
  .code-sidebar { width: 100%; max-height: 200px; border-right: none; border-bottom: 1px solid var(--border); }
}

/* Page header */
.page-header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: flex-start; }
.page-title { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
.page-desc { font-size: 13px; color: var(--text-dim); }
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo"><span class="logo-icon">&#9670;</span> Paper2Product</div>
    <div class="logo-sub">AI Research OS v2.0</div>

    <div class="nav-section">Modules</div>
    <div class="nav-item active" data-page="intake" onclick="showPage('intake', this)"><span class="nav-icon">+</span> New Project</div>
    <div class="nav-item" data-page="studio" onclick="showPage('studio', this)"><span class="nav-icon">&#9881;</span> Artifact Studio</div>
    <div class="nav-item" data-page="lab" onclick="showPage('lab', this)"><span class="nav-icon">&#9879;</span> Experiment Lab</div>
    <div class="nav-item" data-page="api" onclick="showPage('api', this)"><span class="nav-icon">&#10095;</span> API Builder</div>
    <div class="nav-item" data-page="launch" onclick="showPage('launch', this)"><span class="nav-icon">&#9650;</span> Launch Center</div>
    <div class="nav-item" data-page="review" onclick="showPage('review', this)"><span class="nav-icon">&#10003;</span> Team Review</div>

    <div class="nav-section">Projects</div>
    <div id="sidebar-projects" class="project-list">
      <div class="empty-state" style="padding: 20px 0; font-size: 12px;">No projects yet</div>
    </div>

    <div class="sidebar-footer">
      Powered by Groq LLM &middot; <span id="ai-status">Checking...</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main" id="main-content">
    <!-- Page: Project Intake -->
    <div id="page-intake" class="page">
      <div class="page-header">
        <div>
          <div class="page-title">New Project</div>
          <div class="page-desc">Import from ArXiv or paste paper details to run the AI pipeline.</div>
        </div>
      </div>

      <!-- ArXiv Import -->
      <div class="card">
        <div class="card-title" style="margin-bottom: 12px;">Import from ArXiv</div>
        <div class="import-bar">
          <input class="form-input" id="inp-arxiv" placeholder="Paste ArXiv URL or ID (e.g. 2301.12345 or https://arxiv.org/abs/2301.12345)">
          <button class="btn btn-secondary" onclick="fetchArxiv()" id="btn-arxiv">Fetch Paper</button>
        </div>
        <div id="arxiv-status" style="font-size: 12px; color: var(--text-dim);"></div>
      </div>

      <!-- Paper Details Form -->
      <div class="card">
        <div class="card-title" style="margin-bottom: 16px;">Paper Details</div>
        <div class="form-group">
          <label class="form-label">Title</label>
          <input class="form-input" id="inp-title" placeholder="Paper title (min 4 chars)">
        </div>
        <div class="form-group">
          <label class="form-label">Abstract</label>
          <textarea class="form-textarea" id="inp-abstract" rows="3" placeholder="Paste the paper abstract (min 40 chars)"></textarea>
          <div class="form-hint">The abstract helps identify the problem, datasets, and evaluation metrics.</div>
        </div>
        <div class="form-group">
          <label class="form-label">Method / Approach</label>
          <textarea class="form-textarea" id="inp-method" rows="5" placeholder="Paste the method section or describe the approach in detail (min 80 chars). Include equations, architecture details, hyperparameters, training procedures, etc."></textarea>
          <div class="form-hint">The more detail you provide, the better the generated code and analysis will be.</div>
        </div>
        <div class="grid grid-3">
          <div class="form-group">
            <label class="form-label">Framework</label>
            <select class="form-select" id="inp-framework">
              <option value="pytorch">PyTorch</option>
              <option value="tensorflow">TensorFlow</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Persona</label>
            <select class="form-select" id="inp-persona">
              <option value="ml_engineer">ML Engineer</option>
              <option value="founder_pm">Founder / PM</option>
              <option value="designer_educator">Designer / Educator</option>
              <option value="mobile_dev">Mobile Developer</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Source URL</label>
            <input class="form-input" id="inp-url" placeholder="https://arxiv.org/abs/...">
          </div>
        </div>
        <button class="btn btn-primary" onclick="ingestPaper()" id="btn-ingest" style="font-size: 15px; padding: 12px 28px;">
          Run Multi-Agent Pipeline
        </button>
      </div>

      <div id="pipeline-progress" style="display:none;"></div>
      <div id="ingest-result" style="display:none;"></div>
    </div>

    <!-- Page: Artifact Studio -->
    <div id="page-studio" class="page" style="display:none;">
      <div class="page-header">
        <div>
          <div class="page-title">Artifact Studio</div>
          <div class="page-desc">Generated code, visuals, summaries, and analysis.</div>
        </div>
        <div class="btn-group" id="studio-actions"></div>
      </div>
      <div id="studio-content"></div>
    </div>

    <!-- Page: Experiment Lab -->
    <div id="page-lab" class="page" style="display:none;">
      <div class="page-header">
        <div>
          <div class="page-title">Experiment Lab</div>
          <div class="page-desc">Run configs, benchmark dashboard, and experiment tracking.</div>
        </div>
      </div>
      <div id="lab-content"></div>
    </div>

    <!-- Page: API Builder -->
    <div id="page-api" class="page" style="display:none;">
      <div class="page-header">
        <div>
          <div class="page-title">API Builder</div>
          <div class="page-desc">Generated OpenAPI specs, SDK stubs, and API contracts.</div>
        </div>
      </div>
      <div id="api-content"></div>
    </div>

    <!-- Page: Launch Center -->
    <div id="page-launch" class="page" style="display:none;">
      <div class="page-header">
        <div>
          <div class="page-title">Launch Center</div>
          <div class="page-desc">Deployment plans, security checklists, and release configs.</div>
        </div>
      </div>
      <div id="launch-content"></div>
    </div>

    <!-- Page: Team Review -->
    <div id="page-review" class="page" style="display:none;">
      <div class="page-header">
        <div>
          <div class="page-title">Team Review</div>
          <div class="page-desc">Comments, approvals, and governance workflows.</div>
        </div>
      </div>
      <div id="review-content"></div>
    </div>
  </div>
</div>

<script>
const API = '';
let currentProject = null;
let projects = [];
let currentPage = 'intake';

// ─── Init ──────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  loadProjects();
  checkAIStatus();
});

async function checkAIStatus() {
  try {
    const resp = await fetch(API + '/openapi.json');
    document.getElementById('ai-status').innerHTML = resp.ok ?
      '<span style="color:var(--green);">Online</span>' :
      '<span style="color:var(--red);">Offline</span>';
  } catch { document.getElementById('ai-status').innerHTML = '<span style="color:var(--red);">Offline</span>'; }
}

async function loadProjects() {
  try {
    const data = await apiFetch('/api/v2/projects');
    projects = (data.projects || []).map(p => typeof p === 'string' ? null : p).filter(Boolean);
    updateSidebar();
  } catch {}
}

// ─── Navigation ────────────────────────────────────────────────────
function showPage(name, navEl) {
  currentPage = name;
  document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const page = document.getElementById('page-' + name);
  if (page) page.style.display = 'block';
  if (navEl) navEl.classList.add('active');
  else document.querySelector(`.nav-item[data-page="${name}"]`)?.classList.add('active');

  if (currentProject) {
    if (name === 'studio') loadStudio();
    else if (name === 'lab') loadLab();
    else if (name === 'api') loadAPI();
    else if (name === 'launch') loadLaunch();
    else if (name === 'review') loadReview();
  } else if (name !== 'intake') {
    const el = document.getElementById(name === 'studio' ? 'studio-content' : name + '-content');
    if (el) el.innerHTML = `<div class="empty-state"><div class="empty-state-icon">&#9670;</div><div class="empty-state-title">No project selected</div><p>Create a new project or select one from the sidebar.</p></div>`;
  }
}

function toast(msg, type = '') {
  const t = document.createElement('div');
  t.className = 'toast ' + type;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

async function apiFetch(path, opts = {}) {
  const resp = await fetch(API + path, { headers: { 'Content-Type': 'application/json' }, ...opts });
  if (!resp.ok) {
    const err = await resp.json().catch(() => ({ detail: resp.statusText }));
    throw new Error(err.detail || 'Request failed');
  }
  const ct = resp.headers.get('content-type') || '';
  if (ct.includes('json')) return resp.json();
  return resp.blob();
}

// ─── ArXiv Import ──────────────────────────────────────────────────
async function fetchArxiv() {
  const input = document.getElementById('inp-arxiv').value.trim();
  if (!input) { toast('Enter an ArXiv URL or ID', 'error'); return; }

  const btn = document.getElementById('btn-arxiv');
  const status = document.getElementById('arxiv-status');
  btn.disabled = true;
  btn.textContent = 'Fetching...';
  status.innerHTML = '<span class="spinner" style="width:14px;height:14px;border-width:2px;"></span> Fetching from ArXiv...';

  try {
    const isUrl = input.includes('arxiv.org');
    const param = isUrl ? 'url=' + encodeURIComponent(input) : 'id=' + encodeURIComponent(input);
    const data = await apiFetch('/api/v2/arxiv/fetch?' + param);

    document.getElementById('inp-title').value = data.title || '';
    document.getElementById('inp-abstract').value = data.abstract || '';
    document.getElementById('inp-url').value = data.abs_url || '';

    const authors = (data.authors || []).join(', ');
    status.innerHTML = `<span style="color:var(--green);">&#10003;</span> Found: <strong>${esc(data.title)}</strong> by ${esc(authors)} (${data.published?.slice(0,4) || '?'})
      ${data.categories?.length ? '<br>Categories: ' + data.categories.map(c => '<span class="badge badge-blue">' + c + '</span> ').join('') : ''}`;

    toast('Paper imported from ArXiv! Fill in the method section and run the pipeline.', 'success');
  } catch (err) {
    status.innerHTML = `<span style="color:var(--red);">Failed: ${esc(err.message)}</span>`;
    toast('ArXiv fetch failed: ' + err.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Fetch Paper';
  }
}

// ─── Ingest ────────────────────────────────────────────────────────
async function ingestPaper() {
  const btn = document.getElementById('btn-ingest');
  const title = document.getElementById('inp-title').value.trim();
  const abstract = document.getElementById('inp-abstract').value.trim();
  const method = document.getElementById('inp-method').value.trim();

  if (title.length < 4) { toast('Title must be at least 4 characters', 'error'); return; }
  if (abstract.length < 40) { toast('Abstract must be at least 40 characters', 'error'); return; }
  if (method.length < 80) { toast('Method must be at least 80 characters', 'error'); return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Running Pipeline...';
  showPipelineProgress();

  try {
    const payload = {
      title, abstract, method_text: method,
      framework: document.getElementById('inp-framework').value,
      persona: document.getElementById('inp-persona').value,
      source_url: document.getElementById('inp-url').value || undefined,
    };

    const project = await apiFetch('/api/v2/projects/ingest', { method: 'POST', body: JSON.stringify(payload) });

    currentProject = project;
    // Add to list if not already there
    if (!projects.find(p => p.id === project.id)) projects.unshift(project);
    updateSidebar();
    hidePipelineProgress();
    renderIngestResult(project);
    toast('Pipeline complete! All 5 agents finished.', 'success');
  } catch (err) {
    hidePipelineProgress();
    toast('Error: ' + err.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Run Multi-Agent Pipeline';
  }
}

function showPipelineProgress() {
  const el = document.getElementById('pipeline-progress');
  el.style.display = 'block';
  el.innerHTML = `
    <div class="card">
      <div class="card-title">Running 5-Agent Pipeline</div>
      <div class="pipeline-steps">
        <div class="pipeline-step active" id="ps-reader">Reader</div>
        <div class="pipeline-step" id="ps-skeptic">Skeptic</div>
        <div class="pipeline-step" id="ps-implementer">Implementer</div>
        <div class="pipeline-step" id="ps-verifier">Verifier</div>
        <div class="pipeline-step" id="ps-explainer">Explainer</div>
      </div>
      <div class="loading-overlay" style="padding: 20px;"><span class="spinner"></span> Processing paper through AI agents...</div>
    </div>`;
  // Simulate progress
  const steps = ['reader', 'skeptic', 'implementer', 'verifier', 'explainer'];
  steps.forEach((s, i) => {
    setTimeout(() => {
      const step = document.getElementById('ps-' + s);
      if (step && !step.classList.contains('done')) {
        step.classList.add('active');
        if (i > 0) { const prev = document.getElementById('ps-' + steps[i-1]); if (prev) { prev.classList.remove('active'); prev.classList.add('done'); } }
      }
    }, (i + 1) * 800);
  });
}
function hidePipelineProgress() { document.getElementById('pipeline-progress').style.display = 'none'; }

function updateSidebar() {
  const el = document.getElementById('sidebar-projects');
  if (projects.length === 0) {
    el.innerHTML = '<div style="padding: 12px 0; font-size: 12px; color: var(--text-dim); text-align: center;">No projects yet</div>';
    return;
  }
  el.innerHTML = projects.map((p, i) => {
    const isActive = currentProject && p.id === currentProject.id;
    const title = p.ingest?.title || p.paper_spec?.problem?.slice(0, 40) || p.id?.slice(0, 12) || 'Project';
    const score = p.confidence_score || 0;
    const color = score >= 0.7 ? 'var(--green)' : score >= 0.4 ? 'var(--orange)' : 'var(--red)';
    return `<div class="project-item ${isActive ? 'active' : ''}" onclick="selectProject(${i})">
      <div class="project-dot" style="background:${color}"></div>
      <span style="flex:1; overflow:hidden; text-overflow:ellipsis;">${esc(title)}</span>
      <span style="font-size:11px; color:var(--text-dim);">${(score*100).toFixed(0)}%</span>
    </div>`;
  }).join('');
}

async function selectProject(idx) {
  currentProject = projects[idx];
  updateSidebar();
  // Navigate to studio if not on intake
  if (currentPage !== 'intake') {
    showPage(currentPage);
  } else {
    renderIngestResult(currentProject);
    document.getElementById('ingest-result').style.display = 'block';
  }
}

function renderIngestResult(project) {
  const el = document.getElementById('ingest-result');
  el.style.display = 'block';

  const spec = project.paper_spec || {};
  const repro = project.reproducibility || {};
  const msgs = project.agent_messages || [];
  const scaffold = project.code_scaffold || {};
  const scoreColor = (v) => v >= 0.7 ? 'var(--green)' : v >= 0.4 ? 'var(--orange)' : 'var(--red)';

  el.innerHTML = `
    <div class="grid grid-4" style="margin-bottom: 16px;">
      <div class="card stat-card">
        <div class="stat-value" style="color:${scoreColor(project.confidence_score || 0)}">${((project.confidence_score||0)*100).toFixed(0)}%</div>
        <div class="stat-label">Overall Confidence</div>
      </div>
      <div class="card stat-card">
        <div class="stat-value" style="color:${scoreColor(repro.overall || 0)}">${((repro.overall||0)*100).toFixed(0)}%</div>
        <div class="stat-label">Reproducibility</div>
      </div>
      <div class="card stat-card">
        <div class="stat-value">${(scaffold.files || []).length}</div>
        <div class="stat-label">Generated Files</div>
      </div>
      <div class="card stat-card">
        <div class="stat-value">${msgs.length}</div>
        <div class="stat-label">Agent Messages</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Paper Specification</div>
        ${msgs.some(m => m.metadata?.mode === 'ai') ? '<span class="badge badge-purple">AI-Powered</span>' : '<span class="badge badge-orange">Heuristic</span>'}
      </div>
      <table>
        <tr><td style="width:140px; color:var(--text-dim);">Problem</td><td>${esc(spec.problem || '')}</td></tr>
        <tr><td style="color:var(--text-dim);">Method</td><td>${esc(spec.method || '')}</td></tr>
        <tr><td style="color:var(--text-dim);">Datasets</td><td>${(spec.datasets||[]).map(d=>'<span class="badge badge-blue">'+esc(d)+'</span> ').join('')||'<span style="color:var(--text-dim)">None detected</span>'}</td></tr>
        <tr><td style="color:var(--text-dim);">Metrics</td><td>${(spec.metrics||[]).map(m=>'<span class="badge badge-green">'+esc(m)+'</span> ').join('')||'<span style="color:var(--text-dim)">None detected</span>'}</td></tr>
        <tr><td style="color:var(--text-dim);">Architecture</td><td>${(spec.architecture_components||[]).map(a=>'<span class="badge badge-purple">'+esc(a)+'</span> ').join('')||'<span style="color:var(--text-dim)">None detected</span>'}</td></tr>
        <tr><td style="color:var(--text-dim);">Equations</td><td>${(spec.key_equations||[]).map(eq=>'<code class="inline-code">'+esc(eq.raw||String(eq))+'</code>').join(' &middot; ')||'None'}</td></tr>
        <tr><td style="color:var(--text-dim);">Hyperparameters</td><td>${Object.entries(spec.hyperparameters||{}).map(([k,v])=>'<span class="badge badge-orange">'+esc(k)+'='+esc(String(v))+'</span> ').join('')||'None detected'}</td></tr>
      </table>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Reproducibility Scorecard</div>
        <span class="badge ${repro.overall>=0.7?'badge-green':repro.overall>=0.4?'badge-orange':'badge-red'}">${((repro.overall||0)*100).toFixed(0)}%</span>
      </div>
      <div class="grid grid-4" style="margin-bottom:12px;">
        ${['code_available','data_available','hyperparams_complete','compute_specified'].map(k=>`
          <div>
            <div class="progress-bar"><div class="progress-fill" style="width:${((repro[k]||0)*100)}%;background:${(repro[k]||0)>=0.5?'var(--green)':'var(--orange)'}"></div></div>
            <div style="font-size:11px;color:var(--text-dim);margin-top:4px;">${k.replace(/_/g,' ')} ${((repro[k]||0)*100).toFixed(0)}%</div>
          </div>`).join('')}
      </div>
      ${(repro.blockers||[]).length?'<div style="margin-top:8px;"><strong style="color:var(--red);font-size:13px;">Blockers:</strong><ul style="margin:4px 0 0 20px;font-size:13px;">'+repro.blockers.map(b=>'<li>'+esc(b)+'</li>').join('')+'</ul></div>':''}
      ${(repro.fixes||[]).length?'<div style="margin-top:8px;"><strong style="color:var(--green);font-size:13px;">Fixes:</strong><ul style="margin:4px 0 0 20px;font-size:13px;">'+repro.fixes.map(f=>'<li>'+esc(f)+'</li>').join('')+'</ul></div>':''}
    </div>

    <div class="card">
      <div class="card-header"><div class="card-title">Agent Pipeline Trace</div><span class="badge badge-blue">${msgs.length} messages</span></div>
      <div style="max-height:300px;overflow-y:auto;">
      ${msgs.map(m=>{const role=m.role||'unknown';return`<div class="agent-msg ${role}"><div class="agent-role">${esc(role)} <span class="badge badge-blue" style="margin-left:6px;">${((m.confidence||1)*100).toFixed(0)}%</span></div>${esc(m.content)}</div>`;}).join('')}
      </div>
    </div>

    <div class="btn-group" style="margin-top:12px;">
      <button class="btn btn-primary" onclick="showPage('studio')">View Code & Artifacts</button>
      <button class="btn btn-secondary" onclick="productize()">Generate Productization</button>
      <a class="btn btn-success" href="${API}/api/v2/projects/${project.id}/export.zip" download>Download ZIP</a>
    </div>`;
}

// ─── Artifact Studio ───────────────────────────────────────────────
async function loadStudio() {
  if (!currentProject) return;
  const el = document.getElementById('studio-content');
  const actions = document.getElementById('studio-actions');
  el.innerHTML = '<div class="loading-overlay"><span class="spinner"></span> Loading artifacts...</div>';

  try {
    const [scaffold, visual, distill] = await Promise.all([
      apiFetch(`/api/v2/projects/${currentProject.id}/code-scaffold`),
      apiFetch(`/api/v2/projects/${currentProject.id}/visual-graph`),
      apiFetch(`/api/v2/projects/${currentProject.id}/distillation`),
    ]);

    const files = scaffold.files || [];
    const summaries = distill.summaries || {};

    actions.innerHTML = `<a class="btn btn-sm btn-success" href="${API}/api/v2/projects/${currentProject.id}/export.zip" download>Download ZIP</a>`;

    el.innerHTML = `
      <div class="tabs">
        <div class="tab active" onclick="switchTab(this,'studio-code')">Code (${files.length} files)</div>
        <div class="tab" onclick="switchTab(this,'studio-summaries')">Summaries</div>
        <div class="tab" onclick="switchTab(this,'studio-visuals')">Knowledge Graph</div>
        <div class="tab" onclick="switchTab(this,'studio-distill')">Deep Analysis</div>
        <div class="tab" onclick="switchTab(this,'studio-failures')">Failure Modes</div>
      </div>

      <div class="tab-content active" id="studio-code">
        <div class="code-layout">
          <div class="code-sidebar">
            <div style="padding:10px 14px;font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid var(--border);">Files</div>
            ${files.map((f,i)=>`<div class="file-item ${i===0?'active':''}" onclick="showFile(this,${i})" data-idx="${i}">
              <span class="file-icon">${fileIcon(f.path)}</span>
              <span style="flex:1;overflow:hidden;text-overflow:ellipsis;">${esc(f.path)}</span>
            </div>`).join('')}
          </div>
          <div class="code-main">
            <div class="code-header">
              <span id="code-filename">${files[0]?.path||'No files'}</span>
              <span class="badge badge-blue" id="code-lang">${files[0]?.language||''}</span>
            </div>
            <pre id="code-content">${escapeHtml(files[0]?.content||'// No content')}</pre>
          </div>
        </div>
        ${scaffold.architecture_mermaid?`<div class="card" style="margin-top:16px;"><div class="card-title">Architecture Diagram</div><pre style="background:var(--surface2);font-size:12px;">${escapeHtml(scaffold.architecture_mermaid)}</pre></div>`:''}
      </div>

      <div class="tab-content" id="studio-summaries">
        ${Object.entries(summaries).map(([level,text])=>`
          <div class="card">
            <div class="card-header"><div class="card-title">${level==='eli5'?'ELI5 (Simple Explanation)':level==='practitioner'?'Practitioner Level':'Researcher Level'}</div><span class="badge badge-${level==='eli5'?'green':level==='practitioner'?'blue':'purple'}">${level}</span></div>
            <div style="white-space:pre-wrap;font-size:14px;line-height:1.7;">${esc(text)}</div>
          </div>`).join('')}
        ${(distill.quiz_cards||[]).length?`<div class="card"><div class="card-title" style="margin-bottom:12px;">Quiz Cards</div>
          ${distill.quiz_cards.map(q=>`<div style="padding:10px 0;border-bottom:1px solid var(--border);"><div style="display:flex;justify-content:space-between;"><strong style="font-size:13px;">${esc(q.question)}</strong><span class="badge badge-${q.difficulty==='beginner'?'green':q.difficulty==='intermediate'?'blue':q.difficulty==='advanced'?'purple':'red'}">${q.difficulty}</span></div><p style="font-size:12px;color:var(--text-dim);margin-top:6px;">${esc(q.answer)}</p></div>`).join('')}
        </div>`:''}
      </div>

      <div class="tab-content" id="studio-visuals">
        <div class="card">
          <div class="card-title" style="margin-bottom:12px;">Knowledge Graph Nodes</div>
          <table><tr><th>Label</th><th>Type</th></tr>
            ${(visual.architecture_graph?.nodes||[]).map(n=>`<tr><td>${esc(n.label)}</td><td><span class="badge badge-${n.type==='problem'?'red':n.type==='method'?'blue':n.type==='equation'?'purple':n.type==='dataset'?'green':'orange'}">${n.type}</span></td></tr>`).join('')}
          </table>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:12px;">Data Flow</div>
          ${(visual.data_flow_timeline||[]).map(step=>`<div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);"><div class="badge badge-blue" style="min-width:28px;text-align:center;">${step.step}</div><div><strong>${esc(step.name)}</strong><div style="font-size:12px;color:var(--text-dim);">${esc(step.description)}</div></div></div>`).join('')}
        </div>
        ${Object.entries(visual.mermaid_diagrams||{}).map(([name,diagram])=>`<div class="card"><div class="card-title">${esc(name.replace(/_/g,' '))} Diagram</div><pre style="font-size:12px;">${escapeHtml(diagram)}</pre></div>`).join('')}
      </div>

      <div class="tab-content" id="studio-distill">
        <div class="card"><div class="card-title">Research Poster</div><div class="grid grid-2" style="margin-top:12px;"><div><strong>Problem</strong><p style="font-size:13px;margin-top:4px;">${esc(distill.poster?.problem||'')}</p></div><div><strong>Method</strong><p style="font-size:13px;margin-top:4px;">${esc(distill.poster?.method||'')}</p></div></div></div>
        <div class="card"><div class="card-title">Knowledge Cards</div><div class="grid grid-3" style="margin-top:12px;">${(distill.knowledge_cards?.concept_cards||[]).map(c=>`<div class="card" style="margin:0;"><strong>${esc(c.title)}</strong><p style="font-size:12px;color:var(--text-dim);margin-top:4px;">${esc(c.note)}</p></div>`).join('')}</div></div>
        <div class="card"><div class="card-title">Equation Intuition</div>${(distill.knowledge_cards?.equation_intuition_panels||[]).map(eq=>`<div style="padding:10px 0;border-bottom:1px solid var(--border);"><code class="inline-code">${esc(eq.equation)}</code><p style="font-size:13px;margin-top:6px;">${esc(eq.intuition)}</p></div>`).join('')}</div>
        <div class="grid grid-2">
          <div class="card"><div class="card-title">What's Next</div><ul style="margin:12px 0 0 20px;font-size:13px;">${(distill.extension_engine?.what_next||[]).map(w=>'<li style="margin-bottom:4px;">'+esc(w)+'</li>').join('')}</ul></div>
          <div class="card"><div class="card-title">Missing Pieces</div><ul style="margin:12px 0 0 20px;font-size:13px;">${(distill.extension_engine?.missing_piece_detector||[]).map(m=>'<li style="margin-bottom:4px;">'+esc(m)+'</li>').join('')}</ul></div>
        </div>
        ${(distill.counterfactual_analysis||[]).length?`<div class="card"><div class="card-title">Counterfactual Analysis</div><table><tr><th>What If?</th><th>Impact</th><th>Alternative</th></tr>${distill.counterfactual_analysis.map(c=>`<tr><td>${esc(c.question)}</td><td style="font-size:12px;">${esc(c.impact)}</td><td style="font-size:12px;">${esc(c.alternative)}</td></tr>`).join('')}</table></div>`:''}
        <div class="card"><div class="card-title">Learning Path</div><div class="grid grid-3">${['beginner','intermediate','advanced'].map(level=>`<div><strong style="text-transform:capitalize;">${level}</strong><ol style="margin:8px 0 0 20px;font-size:13px;">${(distill.learning_path?.[level]||[]).map(s=>'<li style="margin-bottom:4px;">'+esc(s)+'</li>').join('')}</ol></div>`).join('')}</div></div>
      </div>

      <div class="tab-content" id="studio-failures">
        <div class="card">
          <div class="card-title" style="margin-bottom:12px;">Failure Mode Map</div>
          <table><tr><th>Scenario</th><th>Description</th><th>Impact</th><th>Mitigation</th><th>Severity</th></tr>
            ${(visual.failure_mode_map||[]).map(f=>`<tr><td><strong>${esc(f.scenario)}</strong></td><td style="font-size:12px;">${esc(f.description||'')}</td><td style="font-size:12px;">${esc(f.impact)}</td><td style="font-size:12px;">${esc(f.mitigation)}</td><td><span class="badge badge-${f.severity==='high'?'red':f.severity==='medium'?'orange':'green'}">${f.severity}</span></td></tr>`).join('')}
          </table>
        </div>
      </div>`;

    // Store files for code viewer
    window._studioFiles = files;
  } catch (err) {
    el.innerHTML = `<div class="card"><p style="color:var(--red);">Error loading artifacts: ${esc(err.message)}</p></div>`;
  }
}

function showFile(el, idx) {
  const files = window._studioFiles || [];
  const file = files[idx];
  if (!file) return;
  document.querySelectorAll('.code-sidebar .file-item').forEach(f => f.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('code-filename').textContent = file.path;
  document.getElementById('code-lang').textContent = file.language || '';
  document.getElementById('code-content').textContent = file.content || '// Empty file';
}

function fileIcon(path) {
  if (path.endsWith('.py')) return '&#128013;';
  if (path.endsWith('.js') || path.endsWith('.ts')) return 'JS';
  if (path.endsWith('.json')) return '{}';
  if (path.endsWith('.yml') || path.endsWith('.yaml')) return '&#9881;';
  if (path.endsWith('.md')) return '&#9998;';
  if (path.includes('Dockerfile')) return '&#128230;';
  if (path.endsWith('.txt')) return '&#128196;';
  return '&#128196;';
}

// ─── Experiment Lab ────────────────────────────────────────────────
async function loadLab() {
  if (!currentProject) return;
  const el = document.getElementById('lab-content');
  el.innerHTML = '<div class="loading-overlay"><span class="spinner"></span> Loading experiments...</div>';
  try {
    const [experiments, plans] = await Promise.all([
      apiFetch(`/api/v2/projects/${currentProject.id}/experiments`),
      apiFetch(`/api/v2/projects/${currentProject.id}/experiments/plan`),
    ]);
    el.innerHTML = `
      <div class="card"><div class="card-header"><div class="card-title">Experiment Plans</div><span class="badge badge-blue">${(plans.plans||[]).length} planned</span></div>
        <table><tr><th>Name</th><th>Purpose</th><th>Priority</th></tr>${(plans.plans||[]).map(p=>`<tr><td><strong>${esc(p.name)}</strong></td><td style="font-size:12px;">${esc(p.purpose)}</td><td><span class="badge badge-${p.priority<=2?'green':'blue'}">P${p.priority}</span></td></tr>`).join('')}</table></div>
      <div class="card"><div class="card-header"><div class="card-title">Experiment Runs</div><button class="btn btn-sm btn-primary" onclick="createExperiment()">New Experiment</button></div>
        ${(experiments.experiments||[]).length===0?'<p style="color:var(--text-dim);font-size:13px;">No experiments yet.</p>':
        `<table><tr><th>ID</th><th>Status</th><th>Config</th></tr>${experiments.experiments.map(e=>`<tr><td style="font-family:monospace;font-size:12px;">${(e.id||'').slice(0,8)}</td><td><span class="badge badge-${e.status==='completed'?'green':e.status==='running'?'blue':'orange'}">${e.status}</span></td><td style="font-size:12px;">${esc(JSON.stringify(e.config||{}).slice(0,80))}</td></tr>`).join('')}</table>`}</div>`;
  } catch (err) { el.innerHTML = `<div class="card"><p style="color:var(--red);">Error: ${esc(err.message)}</p></div>`; }
}

async function createExperiment() {
  if (!currentProject) return;
  const config = currentProject.paper_spec?.hyperparameters || {};
  config.epochs = config.epochs || 1;
  try {
    await apiFetch(`/api/v2/projects/${currentProject.id}/experiments`, { method: 'POST', body: JSON.stringify({ config, expected_metrics: {} }) });
    toast('Experiment created!', 'success');
    loadLab();
  } catch (err) { toast('Error: ' + err.message, 'error'); }
}

// ─── Productization ────────────────────────────────────────────────
async function productize() {
  if (!currentProject) return;
  toast('Generating productization assets...');
  try {
    const result = await apiFetch(`/api/v2/projects/${currentProject.id}/productize`, { method: 'POST', body: JSON.stringify({ architecture_type: 'server' }) });
    currentProject.api_contract = result.api_contract;
    currentProject.deployment_plan = result.deployment_plan;
    currentProject.launch_package = result.launch_package;
    toast('Productization complete!', 'success');
  } catch (err) { toast('Error: ' + err.message, 'error'); }
}

// ─── API Builder ───────────────────────────────────────────────────
async function loadAPI() {
  if (!currentProject) return;
  const el = document.getElementById('api-content');
  try {
    const contract = await apiFetch(`/api/v2/projects/${currentProject.id}/api-contract`);
    if (!contract || !contract.endpoints || contract.endpoints.length === 0) {
      el.innerHTML = `<div class="card"><div class="empty-state"><div class="empty-state-icon">&#10095;</div><div class="empty-state-title">No API contract yet</div><p>Generate productization assets first.</p><br><button class="btn btn-primary" onclick="productize().then(()=>loadAPI())">Generate Now</button></div></div>`;
      return;
    }
    el.innerHTML = `
      <div class="tabs">
        <div class="tab active" onclick="switchTab(this,'api-endpoints')">Endpoints (${(contract.endpoints||[]).length})</div>
        <div class="tab" onclick="switchTab(this,'api-sdk')">SDK Stubs</div>
        <div class="tab" onclick="switchTab(this,'api-spec')">OpenAPI Spec</div>
      </div>
      <div class="tab-content active" id="api-endpoints">
        <div class="card"><table><tr><th>Method</th><th>Path</th><th>Summary</th></tr>${(contract.endpoints||[]).map(ep=>`<tr><td><span class="badge badge-${ep.method==='GET'?'green':'blue'}">${ep.method}</span></td><td><code class="inline-code">${esc(ep.path)}</code></td><td style="font-size:13px;">${esc(ep.summary)}</td></tr>`).join('')}</table></div>
        <div class="grid grid-2"><div class="card"><div class="card-title">Rate Limits</div>${Object.entries(contract.rate_limits||{}).map(([k,v])=>`<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;"><span>${esc(k)}</span><span>${v} req/min</span></div>`).join('')}</div><div class="card"><div class="card-title">Auth</div>${Object.entries(contract.auth_config||{}).map(([k,v])=>`<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;"><span>${esc(k)}</span><span>${esc(String(v))}</span></div>`).join('')}</div></div></div>
      <div class="tab-content" id="api-sdk">${Object.entries(contract.sdk_stubs||{}).map(([lang,code])=>`<div class="card"><div class="card-title">${lang.charAt(0).toUpperCase()+lang.slice(1)} SDK</div><pre>${escapeHtml(code)}</pre></div>`).join('')}</div>
      <div class="tab-content" id="api-spec"><div class="card"><div class="card-title">OpenAPI 3.0</div><pre>${escapeHtml(JSON.stringify(contract.openapi_spec||{},null,2))}</pre></div></div>`;
  } catch (err) { el.innerHTML = `<div class="card"><p style="color:var(--red);">Error: ${esc(err.message)}</p></div>`; }
}

// ─── Launch Center ─────────────────────────────────────────────────
async function loadLaunch() {
  if (!currentProject) return;
  const el = document.getElementById('launch-content');
  try {
    const [deploy, launch] = await Promise.all([
      apiFetch(`/api/v2/projects/${currentProject.id}/deployment-plan`),
      apiFetch(`/api/v2/projects/${currentProject.id}/launch-package`),
    ]);
    if (!deploy.architecture_type && !launch.web_deploy) {
      el.innerHTML = `<div class="card"><div class="empty-state"><div class="empty-state-icon">&#9650;</div><div class="empty-state-title">No deployment plan yet</div><p>Generate productization assets first.</p><br><button class="btn btn-primary" onclick="productize().then(()=>loadLaunch())">Generate Now</button></div></div>`;
      return;
    }
    el.innerHTML = `
      <div class="grid grid-2" style="margin-bottom:16px;">
        <div class="card stat-card"><div class="stat-value" style="color:var(--accent-light);">${esc(deploy.architecture_type||'server')}</div><div class="stat-label">Architecture</div></div>
        <div class="card stat-card"><div class="stat-value" style="color:var(--green);">$${deploy.estimated_cost_monthly||0}/mo</div><div class="stat-label">Est. Cost</div></div>
      </div>
      <div class="card"><div class="card-title">Security Checklist</div>${(deploy.security_checklist||[]).map(item=>`<div class="checklist-item"><div class="checklist-check">${item.status==='required'?'!':'?'}</div><div><span>${esc(item.item)}</span> <span class="badge badge-${item.priority==='high'?'red':item.priority==='medium'?'orange':'green'}">${item.priority}</span></div></div>`).join('')}</div>
      <div class="grid grid-2">
        <div class="card"><div class="card-title">Web Deploy Steps</div>${(launch.web_deploy?.deployment_steps||[]).map((s,i)=>`<div class="checklist-item"><div class="checklist-check">${i+1}</div><span style="font-size:13px;">${esc(s)}</span></div>`).join('')}</div>
        <div class="card"><div class="card-title">Container Config</div><pre style="font-size:12px;">${escapeHtml(JSON.stringify(deploy.container_config||{},null,2))}</pre></div>
      </div>
      <div class="card"><div class="card-title">Release Checklist</div>${(launch.release_checklist||[]).map(item=>`<div class="checklist-item"><div class="checklist-check">${item.required?'!':'-'}</div><div>${esc(item.item)} <span class="badge badge-blue">${item.category}</span> ${item.required?'<span class="badge badge-red">required</span>':''}</div></div>`).join('')}</div>
      <a class="btn btn-success" href="${API}/api/v2/projects/${currentProject.id}/export.zip" download>Download Full Package</a>`;
  } catch (err) { el.innerHTML = `<div class="card"><p style="color:var(--red);">Error: ${esc(err.message)}</p></div>`; }
}

// ─── Team Review ───────────────────────────────────────────────────
async function loadReview() {
  if (!currentProject) return;
  const el = document.getElementById('review-content');
  try {
    const reviews = await apiFetch(`/api/v2/projects/${currentProject.id}/reviews`);
    el.innerHTML = `
      <div class="card"><div class="card-header"><div class="card-title">Reviews</div><button class="btn btn-sm btn-primary" onclick="addReview()">Add Review</button></div>
        ${(reviews.reviews||[]).length===0?'<p style="color:var(--text-dim);font-size:13px;">No reviews yet.</p>':
        (reviews.reviews||[]).map(r=>`<div style="padding:12px 0;border-bottom:1px solid var(--border);"><div style="display:flex;justify-content:space-between;margin-bottom:4px;"><strong style="font-size:13px;">${esc(r.author||'anonymous')}</strong><span class="badge badge-${r.status==='approved'?'green':r.status==='rejected'?'red':'orange'}">${r.status}</span></div><p style="font-size:13px;">${esc(r.content)}</p></div>`).join('')}</div>
      <div class="card"><div class="card-title">Approval</div><p style="font-size:13px;color:var(--text-dim);margin:8px 0 12px;">Approve for production export.</p><button class="btn btn-success" onclick="approveProject()">Approve for Production</button></div>`;
  } catch (err) { el.innerHTML = `<div class="card"><p style="color:var(--red);">Error: ${esc(err.message)}</p></div>`; }
}

async function addReview() {
  const content = prompt('Review comment:');
  if (!content) return;
  const author = prompt('Your name:', 'reviewer');
  try { await apiFetch(`/api/v2/projects/${currentProject.id}/reviews`, { method: 'POST', body: JSON.stringify({ author, content }) }); toast('Review added!', 'success'); loadReview(); }
  catch (err) { toast('Error: ' + err.message, 'error'); }
}

async function approveProject() {
  if (!currentProject) return;
  const approver = prompt('Approver name:', 'admin');
  if (!approver) return;
  try { const r = await apiFetch(`/api/v2/projects/${currentProject.id}/approve`, { method: 'POST', body: JSON.stringify({ approver }) }); toast(r.error ? 'Error: ' + r.error : 'Project approved!', r.error ? 'error' : 'success'); }
  catch (err) { toast('Error: ' + err.message, 'error'); }
}

// ─── Utilities ─────────────────────────────────────────────────────
function switchTab(el, contentId) {
  el.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  el.parentElement.parentElement.querySelectorAll(':scope > .tab-content').forEach(tc => tc.classList.remove('active'));
  const target = document.getElementById(contentId);
  if (target) target.classList.add('active');
}

function esc(str) { return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escapeHtml(str) { return esc(str); }
</script>
</body>
</html>
